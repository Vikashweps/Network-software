# Как не потерять данные (Saga)

Представьте: вы покупаете билет на самолет.
1. Авиакомпания бронирует место в своей базе.
2. Банк списывает деньги в своей базе.
3. Билетный агрегатор отправляет PDF на почту.

Если банк не списал деньги (шаг 2 провалился), авиакомпания должна **отменить** бронь (шаг 1). В монолитном приложении вы бы сделали `ROLLBACK` в базе данных. В микросервисах базы разные и находятся на разных серверах. Вам придется делать `ROLLBACK` вручную, запуская специальный код. Это и есть **Компенсация**.

## Ключевые понятия
- **Сага** — это длинная транзакция, разбитая на последовательность локальных транзакций.
- **Оркестрация** — есть главный сервис-"дирижер" (Orchestrator), который говорит другим сервисам, что делать ("Эй, Склад, зарезервируй товар!").
- **Хореография** — сервисы сами слушают события ("О, пришло событие OrderCreated, я должен попытаться списать деньги").
- **Компенсирующая транзакция** — действие, которое "отменяет" результаты предыдущего успешного шага (например, "Вернуть деньги на карту").

## Главное правило Саги
Если шаг N завершился ошибкой, мы должны запустить компенсирующие транзакции для всех успешно выполненных шагов (N-1, N-2 ... 1) в обратном порядке.

## Пример
Яндекс такси: Вы заказали такси (шаг 1). Водитель нашелся (шаг 2). Оплата картой не прошла (ошибка). Сага запускает компенсацию: "Отменить поиск водителя" (откат шага 2) и "Сообщить пользователю об ошибке" (откат шага 1).
